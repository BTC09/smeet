import asyncio
import logging
import json
from aiogram import Bot, Dispatcher, types, F
from aiogram.filters import Command
from aiogram.types import Message, WebAppInfo, InlineKeyboardMarkup, InlineKeyboardButton
from aiogram.utils.keyboard import InlineKeyboardBuilder
from aiogram.types import FSInputFile
import os
from datetime import datetime

# ============================================
# –ù–ê–°–¢–†–û–ô–ö–ò (–ó–ê–ú–ï–ù–ò –ù–ê –°–í–û–ò!)
# ============================================
BOT_TOKEN = "7083456789:AAHxyz..."  # –¢–≤–æ–π —Ç–æ–∫–µ–Ω –æ—Ç @BotFather
WEBAPP_URL = "https://—Ç–≤–æ–π-—Å–∞–π—Ç.com"  # URL –≥–¥–µ –±—É–¥–µ—Ç Mini App
ADMIN_ID = 123456789  # –¢–≤–æ–π Telegram ID

logging.basicConfig(level=logging.INFO)
bot = Bot(token=BOT_TOKEN)
dp = Dispatcher()

# ============================================
# HTML –ö–û–î MINI APP (–í–°–¢–†–û–ï–ù–ù–´–ô)
# ============================================
HTML_CODE = """<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>SMEET | ELITE DETAILING</title>
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Helvetica, Arial, sans-serif;
        }
        body {
            background-color: #0a0a0a;
            color: #ffffff;
            padding: 24px 20px;
        }
        .logo {
            font-size: 48px;
            font-weight: 800;
            margin-bottom: 20px;
            color: #d4af37;
        }
        .car-input {
            width: 100%;
            padding: 16px;
            background: #1a1a1a;
            border: 1px solid #333;
            border-radius: 12px;
            color: #fff;
            margin-bottom: 12px;
        }
        .service-card {
            background: #1a1a1a;
            border-radius: 16px;
            padding: 20px;
            margin-bottom: 12px;
            border: 1px solid #333;
        }
        .service-card.selected {
            border: 2px solid #d4af37;
        }
        .service-price {
            color: #d4af37;
            font-size: 22px;
            font-weight: 700;
        }
        .cart-bar {
            position: fixed;
            bottom: 20px;
            left: 20px;
            right: 20px;
            background: #000;
            border: 2px solid #d4af37;
            border-radius: 30px;
            padding: 16px 24px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        .cart-button {
            background: #d4af37;
            color: #000;
            border: none;
            padding: 12px 24px;
            border-radius: 30px;
            font-weight: 700;
            cursor: pointer;
        }
    </style>
</head>
<body>
    <div class="logo">SMEET<span style="color:#fff;">.</span></div>
    
    <input type="text" class="car-input" id="carBrand" placeholder="–ú–∞—Ä–∫–∞ –∏ –º–æ–¥–µ–ª—å">
    <input type="text" class="car-input" id="carYear" placeholder="–ì–æ–¥ –≤—ã–ø—É—Å–∫–∞">
    
    <h3 style="color:#d4af37; margin: 20px 0;">EXTERIOR</h3>
    <div id="services"></div>
    
    <div class="cart-bar" id="cartBar">
        <div>
            <div style="color:#666; font-size:12px;">TOTAL</div>
            <div class="service-price" id="totalAmount">0 ‚ÇΩ</div>
        </div>
        <button class="cart-button" id="orderButton">BOOK NOW</button>
    </div>

    <script>
        let tg = window.Telegram.WebApp;
        tg.expand();
        
        const services = [
            {id: '1', name: 'GOLD WASH', price: 4500},
            {id: '2', name: 'DIAMOND POLISH', price: 12500},
            {id: '3', name: 'PLATINUM COATING', price: 18900},
            {id: '4', name: 'INTERIOR GOLD', price: 8500}
        ];
        
        let selected = new Set();
        let total = 0;
        
        services.forEach(s => {
            const div = document.createElement('div');
            div.className = 'service-card';
            div.innerHTML = `
                <div style="display:flex; justify-content:space-between;">
                    <span>${s.name}</span>
                    <span class="service-price">${s.price.toLocaleString()} ‚ÇΩ</span>
                </div>
            `;
            div.onclick = () => {
                if(selected.has(s.id)) {
                    selected.delete(s.id);
                    div.classList.remove('selected');
                } else {
                    selected.add(s.id);
                    div.classList.add('selected');
                }
                updateTotal();
            };
            document.getElementById('services').appendChild(div);
        });
        
        function updateTotal() {
            total = 0;
            services.forEach(s => {
                if(selected.has(s.id)) total += s.price;
            });
            document.getElementById('totalAmount').textContent = total.toLocaleString() + ' ‚ÇΩ';
        }
        
        document.getElementById('orderButton').onclick = () => {
            const car = document.getElementById('carBrand').value;
            const year = document.getElementById('carYear').value;
            
            tg.sendData(JSON.stringify({
                car: car,
                year: year,
                total: total,
                services: Array.from(selected)
            }));
        };
    </script>
</body>
</html>
"""

# ============================================
# –û–ë–†–ê–ë–û–¢–ß–ò–ö–ò –ë–û–¢–ê
# ============================================

@dp.message(Command("start"))
async def cmd_start(message: Message):
    """–ö–æ–º–∞–Ω–¥–∞ /start - –ø–æ–∫–∞–∑—ã–≤–∞–µ—Ç –∫–Ω–æ–ø–∫—É —Å Mini App"""
    text = (
        "‚ú® <b>SMEET Detailing ‚Äî Gold Standard</b> ‚ú®\n\n"
        "–î–æ–±—Ä–æ –ø–æ–∂–∞–ª–æ–≤–∞—Ç—å –≤ –ø—Ä–µ–º–∏–∞–ª—å–Ω—ã–π –¥–µ—Ç–µ–π–ª–∏–Ω–≥ —Ü–µ–Ω—Ç—Ä.\n"
        "–ù–∞–∂–º–∏ –∫–Ω–æ–ø–∫—É –Ω–∏–∂–µ, —á—Ç–æ–±—ã –æ—Ç–∫—Ä—ã—Ç—å –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ –∏ –≤—ã–±—Ä–∞—Ç—å —É—Å–ª—É–≥–∏."
    )
    
    builder = InlineKeyboardBuilder()
    builder.add(InlineKeyboardButton(
        text="üöó –û–¢–ö–†–´–¢–¨ SMEET APP",
        web_app=WebAppInfo(url=WEBAPP_URL)
    ))
    
    await message.answer(
        text, 
        reply_markup=builder.as_markup(), 
        parse_mode="HTML"
    )

@dp.message(F.web_app_data)
async def handle_web_app_data(message: Message):
    """–ü–æ–ª—É—á–µ–Ω–∏–µ –∑–∞–∫–∞–∑–æ–≤ –∏–∑ Mini App"""
    try:
        # –ü–æ–ª—É—á–∞–µ–º –¥–∞–Ω–Ω—ã–µ
        data = json.loads(message.web_app_data.data)
        order_time = datetime.now().strftime("%d.%m.%Y %H:%M")
        
        # –§–æ—Ä–º–∏—Ä—É–µ–º –∑–∞–∫–∞–∑
        order_text = (
            f"üîî <b>–ù–û–í–´–ô –ó–ê–ö–ê–ó SMEET GOLD</b>\n\n"
            f"üìÖ <b>–í—Ä–µ–º—è:</b> {order_time}\n"
            f"üë§ <b>–ö–ª–∏–µ–Ω—Ç:</b> {message.from_user.full_name}\n"
            f"üÜî <b>ID:</b> <code>{message.from_user.id}</code>\n"
            f"üì± <b>Username:</b> @{message.from_user.username or '–Ω–µ—Ç'}\n\n"
            f"üöó <b>–ê–í–¢–û–ú–û–ë–ò–õ–¨:</b>\n"
            f"‚Ä¢ –ú–æ–¥–µ–ª—å: {data.get('car', '–ù–µ —É–∫–∞–∑–∞–Ω–æ')}\n"
            f"‚Ä¢ –ì–æ–¥: {data.get('year', '–ù–µ —É–∫–∞–∑–∞–Ω')}\n\n"
            f"üí∞ <b>–ò–¢–û–ì–û:</b> {data.get('total', 0):,} ‚ÇΩ"
        )
        
        # –û—Ç–ø—Ä–∞–≤–ª—è–µ–º –∞–¥–º–∏–Ω—É
        await bot.send_message(ADMIN_ID, order_text, parse_mode="HTML")
        
        # –û—Ç–ø—Ä–∞–≤–ª—è–µ–º –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏–µ –∫–ª–∏–µ–Ω—Ç—É
        await message.answer(
            "‚úÖ <b>–ó–∞—è–≤–∫–∞ —É—Å–ø–µ—à–Ω–æ –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω–∞!</b>\n\n"
            "–ù–∞—à –º–µ–Ω–µ–¥–∂–µ—Ä —Å–≤—è–∂–µ—Ç—Å—è —Å –≤–∞–º–∏ –≤ –±–ª–∏–∂–∞–π—à–µ–µ –≤—Ä–µ–º—è.",
            parse_mode="HTML"
        )
        
    except Exception as e:
        logging.error(f"–û—à–∏–±–∫–∞: {e}")
        await message.answer("‚ùå –ü—Ä–æ–∏–∑–æ—à–ª–∞ –æ—à–∏–±–∫–∞. –ü–æ–ø—Ä–æ–±—É–π—Ç–µ –µ—â–µ —Ä–∞–∑.")

@dp.message(Command("stats"))
async def cmd_stats(message: Message):
    """–°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ (—Ç–æ–ª—å–∫–æ –¥–ª—è –∞–¥–º–∏–Ω–∞)"""
    if message.from_user.id == ADMIN_ID:
        await message.answer(
            "üìä <b>–°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ SMEET</b>\n\n"
            "‚úÖ –ë–æ—Ç –∞–∫—Ç–∏–≤–µ–Ω\n"
            "‚úÖ Mini App –∑–∞–≥—Ä—É–∂–µ–Ω\n"
            "‚úÖ –í—Å–µ —Å–∏—Å—Ç–µ–º—ã —Ä–∞–±–æ—Ç–∞—é—Ç",
            parse_mode="HTML"
        )
    else:
        await message.answer("‚õî –î–æ—Å—Ç—É–ø –∑–∞–ø—Ä–µ—â–µ–Ω")

# ============================================
# –ó–ê–ü–£–°–ö –ë–û–¢–ê
# ============================================
async def main():
    print("üöÄ –ë–æ—Ç SMEET –∑–∞–ø—É—â–µ–Ω!")
    print(f"üë§ Admin ID: {ADMIN_ID}")
    print(f"üåê WebApp URL: {WEBAPP_URL}")
    await dp.start_polling(bot)

if __name__ == "__main__":
    asyncio.run(main())
